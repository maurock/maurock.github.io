<!DOCTYPE html>
<html lang="en">

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>CODE</title>

        <!-- Bootstrap core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet">

        <!-- Custom fonts for this template -->
        <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Raleway:700,200,400,300" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Roboto:700,200,400,300" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet">

        <!-- Plugin CSS -->
        <link href="vendor/magnific-popup/magnific-popup.css" rel="stylesheet" type="text/css">

        <!-- Custom styles for this template -->
        <link href="css/code.css" rel="stylesheet">

    </head>

    <body id="page-top">

        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav">
            <div class="container">
                <a class="navbar-brand js-scroll-trigger" style="font-family: Raleway; font-size: 20px;" href="#page-top">Mauro Comi</a>
                <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fa fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item mx-0 mx-lg-1">
                            <a class="nav-link py-3 px-0 px-lg-3 rounded" href="index.html#portfolio">My Projects</a>
                        </li>
                        <li class="nav-item mx-0 mx-lg-1">
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="#about">About me</a>
                        </li>
                        <li class="nav-item mx-0 mx-lg-1">
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="#contact">Contact</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>


        <!-- Code -->
        <section class="code" id="prediction">
            <div class="container">
                <h2 class="text-center text-uppercase text-secondary mb-0" style="margin-top: 50px;">Flight Delay Prediction</h2>
                <br><br>

                <div class="snippet"><h5><b>Introduction</b></h5>For this Project I used the data published by the US Department of Transportation related to the year 2007. This dataset is composed of 7.453.215 observations
                    and 29 different variables. The objective of this assignment is to develop a Spark application in order to predict the delay of commercial flights. To achieve this, I followed these steps:
                    <ul>
                        <li>Load the input data, previously stored at a known location.</li>
                        <li>Select, process and transform the input variables, to prepare them for training the model.</li>
                        <li>Perform some basic analysis of each input variable.</li>
                        <li>Validate the created a Machine Learning model and provide some measures of its accuracy.</li>
                    </ul>
         
                    The language chosen for the application is <b>Scala</b>, and <b>R</b> for initial data exploration and plotting.
                    The App was developed using IntelliJ as IDE and SBT as build manager.</div>

                <!-- PRIMA PARTE -->
                <div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.log4j.</span><span style="color: #333333">{</span><span style="color: #BB0066; font-weight: bold">Level</span><span style="color: #333333">,</span> <span style="color: #BB0066; font-weight: bold">Logger</span><span style="color: #333333">}</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.ml.Pipeline</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.ml.evaluation.RegressionEvaluator</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.ml.feature.</span><span style="color: #333333">{</span><span style="color: #BB0066; font-weight: bold">StringIndexer</span><span style="color: #333333">,</span> <span style="color: #BB0066; font-weight: bold">VectorAssembler</span><span style="color: #333333">,</span> <span style="color: #BB0066; font-weight: bold">VectorIndexer</span><span style="color: #333333">}</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.sql.SparkSession</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.sql.functions._</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.sql.types._</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">org.apache.spark.ml.regression.</span><span style="color: #333333">{</span><span style="color: #BB0066; font-weight: bold">DecisionTreeRegressionModel</span><span style="color: #333333">,</span> <span style="color: #BB0066; font-weight: bold">DecisionTreeRegressor</span><span style="color: #333333">,</span> <span style="color: #BB0066; font-weight: bold">RandomForestRegressor</span><span style="color: #333333">,</span> <span style="color: #BB0066; font-weight: bold">RandomForestRegressionModel</span><span style="color: #333333">}</span>
</pre></div>

<div class="snippet">First of all, I created the Spark Session. The master is set on <i>local[*]</i> in order to work on all the available cores. This value can be modified in order to reduce computational power needed, to the detriment of speed. </div>

                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">//Create Spark session</span>
  <span style="color: #008800; font-weight: bold">val</span> spark <span style="color: #008800; font-weight: bold">=</span> <span style="color: #BB0066; font-weight: bold">SparkSession</span>
    <span style="color: #333333">.</span>builder<span style="color: #333333">()</span>
    <span style="color: #333333">.</span>master<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;local[*]&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>appName<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Big Data Project&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>getOrCreate<span style="color: #333333">()</span>
</pre></div>

                <div class="snippet">I created the function <i>createPartialdata(int)</i> in order to create a reduced dataset with a customized number of lines. All the variables are casted with their correct Data Type, the null values are eliminated and the dataset is saved as a .csv file. This file will be used for initial data exploration, in order to reduce running time. Initially I generated a dataset containing 700 thousand rows (10% of the original dataset). </div>


                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">def</span> createpartialData<span style="color: #333333">(</span>limitation<span style="color: #008800; font-weight: bold">:</span> <span style="color: #333399; font-weight: bold">Int</span><span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">=</span> <span style="color: #333333">{</span>
      <span style="color: #008800; font-weight: bold">var</span> path2 <span style="color: #008800; font-weight: bold">=</span> <span style="background-color: #fff0f0">&quot;src/main/scala/2007.csv.bz2&quot;</span>
      <span style="color: #008800; font-weight: bold">var</span> inputDF <span style="color: #008800; font-weight: bold">=</span> spark<span style="color: #333333">.</span>read<span style="color: #333333">.</span>format<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;csv&quot;</span><span style="color: #333333">).</span>option<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;delimiter&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;,&quot;</span><span style="color: #333333">)</span>
        <span style="color: #333333">.</span>option<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;header&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;true&quot;</span><span style="color: #333333">)</span>
        <span style="color: #333333">.</span>load<span style="color: #333333">(</span>path2<span style="color: #333333">)</span>
        <span style="color: #333333">.</span>select<span style="color: #333333">(</span>
          col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Month&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">),</span>
          col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DayOfMonth&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">),</span>
          col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DayOfWeek&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
          col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DepTime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
          col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;CRSDepTime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;CRSArrtime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;UniqueCarrier&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;CRSElapsedTime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;ArrDelay&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DepDelay&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Origin&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Dest&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Distance&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Cancelled&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">),</span>
        col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;TaxiOut&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">))</span>

    <span style="color: #008800; font-weight: bold">var</span> real_data1 <span style="color: #008800; font-weight: bold">=</span> inputDF<span style="color: #333333">.</span>na<span style="color: #333333">.</span>drop<span style="color: #333333">()</span>
    <span style="color: #008800; font-weight: bold">var</span> onepiece <span style="color: #008800; font-weight: bold">=</span> real_data1<span style="color: #333333">.</span>select<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;*&quot;</span><span style="color: #333333">).</span>limit<span style="color: #333333">(</span>limitation<span style="color: #333333">)</span>
    onepiece<span style="color: #333333">.</span>write<span style="color: #333333">.</span>option<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;header&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;true&quot;</span><span style="color: #333333">).</span>csv<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;src/main/scala/partialdata_&quot;</span> <span style="color: #333333">+</span> limitation<span style="color: #333333">.</span>toString <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;.csv&quot;</span><span style="color: #333333">)</span>
</pre></div>
                
                <div class="snippet"><h5><b>Data exploration</b></h5>The ordinal variables Month, DayOfWeek and DayOfMonth were not concatenated to generate complete dates, but were handled separately. This choice allows to better detect patterns during specific days or months. Indeed, the following R histogram plot representing the average delay per month shows a significant difference in the average delay depending on the month: <br><br>
                <img src="img/flight1/avgmonth.png" style="width:90%;height: auto; max-width: 550px; display: block;    margin: 0 auto;" alt="Average Month">
                <br><br>
                    An initial analysis is performed on selected variables, specifically the linear correlation between DepDelay and ArrDelay is studied and plotted in R. The correlation is 0.92, and represents the highest correlation among all the variables, as shown below. 
                    <br><br><img src="img/flight1/corr_1.png" style="width:90%;height: auto; max-width: 550px; display: block;    margin: 0 auto;" alt="Average Month"><br>                    
                    Further correlations are computed with the <i>hetcor() </i>function provided in R, which guarantees reliable results with categorical and nominal variables. To perform these operations, I used a Dataframe containing a partial data of 1 million rows. In order to improve the selection of the most relevant variables, it's possible to generate a Random Forest Model and then use the function <i>featureImportances()</i> provided in <i>spark.ml.regression.RandomForestRegressionModel</i> to assess the choice of variables. This allows to obtain a vector representing the importance of every variable used in the Random Forest regressor. This function generalizes the Gini impurity index, producing a float value per variable in the range of 0-1.
                </div>
                
            
            

                <div class="snippet"><h5><b>Data selection and creation of new variables</b></h5>The dataset is loaded as a Spark DataFrame. The variables are casted with their correct DataType.</div>


                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%"> <span style="color: #008800; font-weight: bold">var</span> inputDF <span style="color: #008800; font-weight: bold">=</span> spark<span style="color: #333333">.</span>read<span style="color: #333333">.</span>format<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;csv&quot;</span><span style="color: #333333">).</span>option<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;delimiter&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;,&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>option<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;header&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;true&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>load<span style="color: #333333">(</span>path<span style="color: #333333">)</span>
    <span style="color: #333333">.</span>select<span style="color: #333333">(</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Month&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DayOfMonth&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DayOfWeek&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DepTime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;CRSDepTime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;CRSArrtime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;UniqueCarrier&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;CRSElapsedTime&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;ArrDelay&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DepDelay&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Origin&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Dest&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">StringType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Distance&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">DoubleType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Cancelled&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">),</span>
      col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;TaxiOut&quot;</span><span style="color: #333333">).</span>cast<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">IntegerType</span><span style="color: #333333">))</span>
</pre></div>

                
                
         <div class="snippet">A new variable, containing the Origin and the Destination, is created in the column <i>trip</i>. This categorical variable helps to identify the categories of unique combination between Origins and Destinies. For example: <br>
             <div style="text-align: center;"> SMF (Origin) + SAN (Dest) = SMFSAN (Trip)</div></div>

                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">//Create variable trip, concatenating Origin and Dest</span>
  real_data1 <span style="color: #008800; font-weight: bold">=</span> real_data1<span style="color: #333333">.</span>withColumn<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;trip&quot;</span><span style="color: #333333">,</span> concat<span style="color: #333333">(</span>real_data1<span style="color: #333333">.</span>col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Origin&quot;</span><span style="color: #333333">),</span> real_data1<span style="color: #333333">.</span>col<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Dest&quot;</span><span style="color: #333333">)))</span>
</pre></div>

                <div class="snippet">The categorical variables UniqueCarrier, Dest and Origin are casted as StringType. Since the
Random Forest algorithm, as well as the Linear Regression, do not handle the String type, those
variables were converted and indexed to type Double. This operation was performed creating a new
StringIndexer object, in order to fit and transform the original DataFrame.</div>

                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #888888">//Index the variable Dest into integer values, creating a new variable: dest_numerical</span>
  <span style="color: #008800; font-weight: bold">var</span> indexer2 <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">StringIndexer</span><span style="color: #333333">().</span>setInputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Dest&quot;</span><span style="color: #333333">).</span>setOutputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;dest_numerical&quot;</span><span style="color: #333333">)</span>
  real_data1 <span style="color: #008800; font-weight: bold">=</span> indexer2<span style="color: #333333">.</span>fit<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>transform<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>drop<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Dest&quot;</span><span style="color: #333333">)</span>

  <span style="color: #888888">//Index the variable UniqueCarrier into integer values, creating a new variable: carrier_numerical</span>
  <span style="color: #008800; font-weight: bold">var</span> indexer4 <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">StringIndexer</span><span style="color: #333333">().</span>setInputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;UniqueCarrier&quot;</span><span style="color: #333333">).</span>setOutputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;carrier_numerical&quot;</span><span style="color: #333333">)</span>
  real_data1 <span style="color: #008800; font-weight: bold">=</span> indexer4<span style="color: #333333">.</span>fit<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>transform<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>drop<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;UniqueCarrier&quot;</span><span style="color: #333333">)</span>

  <span style="color: #888888">//Index the variable Origin into integer values, creating a new variable: origin_numerical</span>
  <span style="color: #008800; font-weight: bold">var</span> indexer3 <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">StringIndexer</span><span style="color: #333333">().</span>setInputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Origin&quot;</span><span style="color: #333333">).</span>setOutputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;origin_numerical&quot;</span><span style="color: #333333">)</span>
  real_data1 <span style="color: #008800; font-weight: bold">=</span> indexer3<span style="color: #333333">.</span>fit<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>transform<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>drop<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Origin&quot;</span><span style="color: #333333">)</span>

  <span style="color: #888888">//Index the variable Origin into integer values, creating a new variable: trip_numerical</span>
  <span style="color: #008800; font-weight: bold">var</span> indexer5 <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">StringIndexer</span><span style="color: #333333">().</span>setInputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;trip&quot;</span><span style="color: #333333">).</span>setOutputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;trip_numerical&quot;</span><span style="color: #333333">)</span>
  real_data1 <span style="color: #008800; font-weight: bold">=</span> indexer5<span style="color: #333333">.</span>fit<span style="color: #333333">(</span>real_data1<span style="color: #333333">).</span>transform<span style="color: #333333">(</span>real_data1<span style="color: #333333">)</span>
  real_data1<span style="color: #333333">.</span>createOrReplaceTempView<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;real_data1&quot;</span><span style="color: #333333">)</span>
  println<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;The complete Dataset, after transformation and creation of new variables: &quot;</span><span style="color: #333333">)</span>
  real_data1<span style="color: #333333">.</span>show<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">)</span>
</pre>
                <br><img src="img/flight1/data1.PNG" style="width:100%;height: auto; display: block;    margin: 0 auto; min-width: 900px" alt="Average Month"><br>
                
                </div>



<div class="snippet">The final variables selected, after pre-processing and data exploration, are <i>DepDelay, TaxiOut, CRSDepTime, DepTime</i>. An object VectorAssembler is generated, to create a column containing a vector with all the features per instance. This column will be used later as input for a VectorIndexer. </div>

                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">//Create a vector assembler, to generate the input for the Vector Indexer, and print the variables used</span>
  <span style="color: #008800; font-weight: bold">var</span> array <span style="color: #008800; font-weight: bold">=</span> <span style="color: #BB0066; font-weight: bold">Array</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DepDelay&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;TaxiOut&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;CRSDepTime&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;DepTime&quot;</span><span style="color: #333333">)</span>
  <span style="color: #008800; font-weight: bold">var</span> vectorAssembler <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">VectorAssembler</span><span style="color: #333333">()</span>
    <span style="color: #333333">.</span>setInputCols<span style="color: #333333">(</span>array<span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setOutputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;features&quot;</span><span style="color: #333333">)</span>
  <span style="color: #008800; font-weight: bold">val</span> assemblerData <span style="color: #008800; font-weight: bold">=</span> vectorAssembler<span style="color: #333333">.</span>transform<span style="color: #333333">(</span>real_data1<span style="color: #333333">)</span>
  println<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;The variables used are: &quot;</span><span style="color: #333333">)</span>
  array<span style="color: #333333">.</span>foreach<span style="color: #333333">(</span>x <span style="color: #008800; font-weight: bold">=&gt;</span> print<span style="color: #333333">(</span>x <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;   &quot;</span><span style="color: #333333">))</span>
  println<span style="color: #333333">()</span>
</pre></div>


                
                <div class="snippet">The object VectorIndexer receives as input the column of features generated by the previous VectorAssembler, and returns as output a column with the indexed features. This is necessary for the Random Forest model. To validate the model generated I randomly split the dataset in a training set (75% of the original dataset) and a test set (25%). The prediction model was created using ArrDelay as the target variable, The depth of the trees, which is 4 as default, was increased up to 7 (RMSE = 11,6) and 9 (RMSE = 11.07), resulting in a better accuracy to the detriment of the running time. The number of trees are 20 as default. In order to implement the indexed categories <i>Dest, Origin</i> and <i>Trip</i> I initially increased the maximum number of categories of the model to 5032, as well as the number of bins. This operation allows the algorithm to consider every variable with a number of distinct values lower than 5032 to be considered categorical. This number was chosen because itâ€™s the number of different distinct values present in <i>Trip</i>. At the end, this setting did not improve the final accuracy, so it was discarded and the maximum number of bins was set at 700.</div>



                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">// RANDOM FOREST</span>
  <span style="color: #888888">//Creating a Vector Indexer to generate the input for the Random Forest model</span>
  <span style="color: #008800; font-weight: bold">val</span> indexer <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">VectorIndexer</span><span style="color: #333333">()</span>
    <span style="color: #333333">.</span>setInputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;features&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setOutputCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;indexedFeatures&quot;</span><span style="color: #333333">)</span>

  <span style="color: #008800; font-weight: bold">val</span> indexerModel <span style="color: #008800; font-weight: bold">=</span> indexer<span style="color: #333333">.</span>fit<span style="color: #333333">(</span>assemblerData<span style="color: #333333">)</span>

  <span style="color: #888888">// Create new column &quot;indexedData&quot; with categorical values transformed to indices</span>
  <span style="color: #008800; font-weight: bold">val</span> indexedData <span style="color: #008800; font-weight: bold">=</span> indexerModel<span style="color: #333333">.</span>transform<span style="color: #333333">(</span>assemblerData<span style="color: #333333">)</span>

  <span style="color: #888888">//Splitting the dataset in training and test set</span>
  <span style="color: #008800; font-weight: bold">val</span> split <span style="color: #008800; font-weight: bold">=</span> indexedData<span style="color: #333333">.</span>randomSplit<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">Array</span><span style="color: #333333">(</span><span style="color: #6600EE; font-weight: bold">0.75</span><span style="color: #333333">,</span> <span style="color: #6600EE; font-weight: bold">0.25</span><span style="color: #333333">))</span>
  <span style="color: #008800; font-weight: bold">var</span> training <span style="color: #008800; font-weight: bold">=</span> split<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">)</span>
  <span style="color: #008800; font-weight: bold">var</span> test <span style="color: #008800; font-weight: bold">=</span> split<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">)</span>

  <span style="color: #888888">//Setting the Random Forest regressor</span>
  <span style="color: #008800; font-weight: bold">val</span> rf <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">RandomForestRegressor</span><span style="color: #333333">()</span>
    <span style="color: #333333">.</span>setLabelCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;ArrDelay&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setFeaturesCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;features&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setMaxDepth<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">9</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setMaxBins<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">700</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setFeatureSubsetStrategy<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;auto&quot;</span><span style="color: #333333">)</span>

  <span style="color: #888888">// Chain indexer and forest in a Pipeline.</span>
  <span style="color: #008800; font-weight: bold">val</span> pipeline <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">Pipeline</span><span style="color: #333333">()</span>
    <span style="color: #333333">.</span>setStages<span style="color: #333333">(</span><span style="color: #BB0066; font-weight: bold">Array</span><span style="color: #333333">(</span>rf<span style="color: #333333">))</span>

  <span style="color: #888888">// Train model. This also runs the indexer.</span>
  <span style="color: #008800; font-weight: bold">val</span> model <span style="color: #008800; font-weight: bold">=</span> pipeline<span style="color: #333333">.</span>fit<span style="color: #333333">(</span>training<span style="color: #333333">)</span>
</pre></div>


 <div class="snippet"> The function <i>featureImportances()</i> provided in Spark.ml.regression.RandomForestRegressionModel assesses the choice of variables, obtaining a vector representing the importance of every variable used
in the Random Forest regressor. This function generalizes the Gini impurity index, producing a
float value per variable in the range of 0-1. The importance of the variables is shown below. The variable 0, related to <i>DepDelay</i> presents the highest correlation, as intuition might suggests.Indeed, if a departure is delayed, the arrival will be probably delayed as well. </div>

                
                

                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">//Calculating and printing the importance of every variable used</span>
  <span style="color: #008800; font-weight: bold">val</span> importance <span style="color: #008800; font-weight: bold">=</span> model<span style="color: #333333">.</span>stages<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">).</span>asInstanceOf<span style="color: #333333">[</span><span style="color: #333399; font-weight: bold">RandomForestRegressionModel</span><span style="color: #333333">].</span>featureImportances
  println<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Importance, in order of variable: &quot;</span><span style="color: #333333">)</span>
  importance<span style="color: #333333">.</span>toArray<span style="color: #333333">.</span>zipWithIndex
    <span style="color: #333333">.</span>map<span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">_</span><span style="color: #333333">.</span>swap<span style="color: #333333">)</span>
    <span style="color: #333333">.</span>sortBy<span style="color: #333333">(-</span><span style="color: #008800; font-weight: bold">_</span><span style="color: #333333">.</span>_2<span style="color: #333333">)</span>
    <span style="color: #333333">.</span>foreach<span style="color: #333333">(</span>x <span style="color: #008800; font-weight: bold">=&gt;</span> println<span style="color: #333333">(</span>x<span style="color: #333333">.</span>_1 <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; -&gt; &quot;</span> <span style="color: #333333">+</span> x<span style="color: #333333">.</span>_2<span style="color: #333333">))</span>
</pre>
                <br>
                <img src="img/flight1/importance.PNG" style="width: 300px; height: auto; margin-left: 15px">
                </div>

                
                
                <div class="snippet">Predictions are then computed, based on the model. The result is printed below: </div>



                <!-- HTML generated using hilite.me --><div style="bbackground: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">// Make predictions.</span>
  <span style="color: #008800; font-weight: bold">var</span> predictions <span style="color: #008800; font-weight: bold">=</span> model<span style="color: #333333">.</span>transform<span style="color: #333333">(</span>test<span style="color: #333333">)</span>

  <span style="color: #888888">// Select example rows to display.</span>
  println<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Prediction table: &quot;</span><span style="color: #333333">)</span>
  predictions<span style="color: #333333">.</span>select<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;prediction&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;ArrDelay&quot;</span><span style="color: #333333">).</span>show<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">5</span><span style="color: #333333">)</span>
</pre>
                <br>
                <img src="img/flight1/predictions.png" style="width: 250px; height: auto; margin-left: 15px">
                
                </div>

                
                <div class="snippet">As measure of the algorithm efficiency, the root-mean-square error (RMSE) was calculated. The result, using as input variables DepDelay, TaxiOut, CRSDepTime and DepTime, with a depth of trees equal to 9 and the maximum number of bins equal to 700, is 11.07. This means that this model predicts the delay of a Flight, given the 4 variables overmentioned, with an average error of <b>11 minutes</b>.</div>


                <!-- HTML generated using hilite.me --><div style="background: #ffffff;overflow:auto;width:auto;border: solid #c1c1c1;border-width: .05em .05em .05em .05em;border-radius: 0.5em;padding: 0.8em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">//Evaluating the accuracy using RMSE</span>
  <span style="color: #008800; font-weight: bold">val</span> evaluator <span style="color: #008800; font-weight: bold">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #BB0066; font-weight: bold">RegressionEvaluator</span><span style="color: #333333">()</span>
    <span style="color: #333333">.</span>setLabelCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;ArrDelay&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setPredictionCol<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;prediction&quot;</span><span style="color: #333333">)</span>
    <span style="color: #333333">.</span>setMetricName<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;rmse&quot;</span><span style="color: #333333">)</span>
  <span style="color: #008800; font-weight: bold">val</span> rmse <span style="color: #008800; font-weight: bold">=</span> evaluator<span style="color: #333333">.</span>evaluate<span style="color: #333333">(</span>predictions<span style="color: #333333">)</span>
  println<span style="color: #333333">()</span>
  println<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Root Mean Squared Error (RMSE) on test data = &quot;</span> <span style="color: #333333">+</span> rmse<span style="color: #333333">)</span>
</pre>
                <br>
                <img src="img/flight1/rmse.png" style="margin-left: 15px; width: 550px; height: auto;">
                
                </div>



            </div>
        </section>



        <!-- Footer -->
        <footer class="footer text-center">
            <div class="container">

        <div class="copyright py-4 text-center text-white">
            <div class="container">
                <small>Copyright &copy; Your Website 2017</small>
            </div>
        </div>

        <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
        <div class="scroll-to-top d-lg-none position-fixed ">
            <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top">
                <i class="fa fa-chevron-up"></i>
            </a>
        </div>



        <!-- Bootstrap core JavaScript -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <!-- Plugin JavaScript -->
        <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
        <script src="vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

        <!-- Contact Form JavaScript -->
        <script src="js/jqBootstrapValidation.js"></script>
        <script src="js/contact_me.js"></script>

        <!-- Custom scripts for this template -->
        <script src="js/freelancer.min.js"></script>

    </body>

</html>
