<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Develop a Deep Reinforcement Learning agent to play the game Snake">
    <meta name="author" content="Mauro Comi">

    <title>Deep Reinforcement Learning for Games</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Raleway:700,200,400,300, 500" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:700,200,400,300, 500" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <!-- Plugin CSS -->
    <link href="vendor/magnific-popup/magnific-popup.css" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template -->
    <link href="css/freelancer.css" rel="stylesheet">

</head>

<body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav">
        <div class="container">
            <a class="navbar-brand js-scroll-trigger" style="font-family: Raleway; font-size: 20px;" href="https://maurocomi.com/index.html">Mauro Comi</a>
            <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fa fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#research">Research</a>
                        </div>
                    </li>
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#portfolio">My Projects</a>
                        </div>
                    </li>
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#about_desktop_mobile">About me</a>
                        </div>
                    </li>
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#contact">Contact</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <!-- Code -->
    <section class="code" id="prediction">
        <div class="container">
            <h2 class="text-center text-uppercase text-secondary mb-0" style="margin-top: 50px; line-height: 1.2">Deep Reinforcement Learning for Game Bot</h2>
            <br><br>
            <img src="img/neural-network.jpg" class="container" style="max-width: 100%; height: 30vh;object-fit: cover">

            <div class="snippet">
                <h3><b>Introduction</b></h3>The goal of this project is to develop a <b>AI Bot</b> able to learn how to play the popular game Snake from scratch. In order to do it, I implemented a <b>Deep Reinforcement Learning algorithm</b>, a field of unsupervised Machine Learning. This approach consists in giving the system parameters related to its state, and a positive or negative reward based on its actions. No rules about the game are given, and initially the Bot has no information on what it needs to do. The goal for the system is to figure it out and elaborate a strategy to maximize the score - or the reward.<br>
                We are going to see how a Deep Q-Learning algorithm learns how to play snake, scoring up to 50 points and showing a solid strategy after only 5 minutes of training.<br>
                You can check the <span><b>GitHub Repository</b><img src="img/github-icon.png" style="height: 20px; margin-left: 5px;"></span> for the full code: <br>
                <a href="https://github.com/maurock/snake-ga" class="text-center btn_custom-inverse first_btn-inverse" style="font-size: 16px; font-family: Roboto; font-weight: 500; width: fit-content; margin: auto; margin-bottom: 10px; margin-top: 10px">Check full code<span class="fa fa-long-arrow-right" aria-hidden="true" style="margin-left: 8px"></span></a>

                Here you can see the two games: on the left, the AI does not know anything about the game. On the right, the AI is trained and learnt how to play.<br>

                <div style="text-align: center">
                    <img class="snakegif-norl" , src="img/notraining.gif">
                    <img class="snakegif-rl" src="img/training.gif">
                </div>
                <br><br>
                <h3><b>Learning goals</b></h3>
                <ul>
                    <li>Understand and Implement a Deep Q-Learning algorithm for optimization</li>
                    <li>Improve the algorithm with different strategies -> Store long-term memory, Experience memory, Random actions</li>
                </ul>
                <br>
                <h3><b>How does it work?</b></h3>
                Reinforcement Learning is an approach based on Markov Decision Process to make decisions, as<a href="http://cs229.stanford.edu/notes/cs229-notes12.pdf" style="color: #2885e2ed"> perfectly explained here</a> by Andrew NG at Standford University. <br>
                In my implementation, I used <b>Deep Q-Learning</b> instead of a traditional supervised Machine Learning approach. What's the difference? Traditional ML algorithms need to be trained with an input and a "correct answer" called target. The system will then try to learn how to predict the target according to new input. In this example, we don't know what's the best action to take at each state of the game, so a traditional approach would not be effective. <br>
                In Reinforcement Learning we pass a <b>reward</b>, positive or negative depending on the action the system took, and the algorithm needs to learn what actions can maximize the reward, and which need to be avoided. <br>

                To understand how the agent takes decisions, it's important to understand what a Q-Table is. A Q-table is a matrix, which correlates the <i>state</i> of the agent with the possible actions that the system can adopt. The values in the table are the action's probability of success, based on the rewards it got during the training. <br>
                <br>
                <div>
                    <table class="table table-bordered" style="width: 60%; line-height :1em; margin: auto">
                        <thead>
                            <tr>
                                <th scope="col">State</th>
                                <th scope="col">Right</th>
                                <th scope="col">Left</th>
                                <th scope="col">Up</th>
                                <th scope="col">Down</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td>0</td>
                                <td>0.31</td>
                                <td>0.12</td>
                                <td style="background-color: #19ce0085">0.87</td>
                            </tr>
                            <tr>
                                <th scope="row">2</th>
                                <td style="background-color: #19ce0085">0.98</td>
                                <td>-0.12</td>
                                <td>0.01</td>
                                <td>0.14</td>
                            </tr>
                            <tr>
                                <th scope="row">3</th>
                                <td>1</td>
                                <td>0.10</td>
                                <td>0.12</td>
                                <td style="background-color: #19ce0085">0.31</td>
                            </tr>
                            <tr>
                                <th scope="row">4</th>
                                <td>0.19</td>
                                <td>0.14</td>
                                <td style="background-color: #19ce0085">0.87</td>
                                <td>-0.12</td>
                            </tr>
                        </tbody>

                    </table>
                    <p style="text-align: center;"><i>Representation of a Q-Table</i></p>
                </div>

                Deep Q-Learning increases the potentiality of Q-Learning, continuously updating the Q-table based on the prediction of future states.
                The Q-values are updated according to the Bellman equation: <br><br>
                <img class="bellman-eq" src="img/bellman.bmp.png" style="margin: auto;display: block;"><br>

                On a general level the algorithm works as follow:<br>
                <ul>
                    <li> The game starts, and the Q-value is randomly initialized.</li>
                    <li>The system gets the current state <b>s</b>.</li>
                    <li>Based on s, it executes an <b>action</b>, randomly or based on its neural network. During the first phase of the training, the system often chooses random actions in order to maximize <b>exploration.</b> Later on, the system relies more and more on its neural network. </li>
                    <li>When the AI chooses and performs the action, the system collects the <b>reward</b>. It now gets the new state <b>state'</b> and it updates its Q-value with the Bellman equation as mentioned above. Also, for each move it stores the original state, the action, the state reached after performed that action, the reward obtained and whether the game ended or not. This data is later sampled to train the neural network.</li>
                    <li>These last two operations are repeated until a certain condition is met</li><br>
                </ul>
                <h4><b>State</b></h4>
                A state is the representation of a situation in which the agent finds itself.
                The state represents the input of the Neural network of the AI. <br>
                In our case, the state is an array containing 11 boolean variables. It takes into account:<br>
                - if there's an immediate danger in the snake's proximity (right, left and straight).<br>
                - if the snake is moving up, down, left or right.<br>
                - if the food is above, below, on the left or on the right.<br><br>

                <h4><b>Loss</b></h4>
                The Deep neural network optimizes the answer (action) to a specific input (state) trying to maximize the reward. The value to express how good is the prediction is called Loss. The job of a neural network is to minimize the loss, reducing then the difference between the real target and the predicted one.
                In our case, the loss is expressed as:

                $$ loss = \left( r + \gamma max_a  \textcolor{red}{\hat{Q}}(s, a') - \textcolor{red}{Q}(s, a) \right)^2 $$

                
                
                <h4><b>Reward</b></h4>
                As said, the AI tries to maximize the reward.
                The only reward given to the system is when it eats the food target (+10). If the snake hits a wall or hits itself, the reward is negative (-10). Additionally, there could be given a positive reward for each step the snake takes without dying. In that case, the risk is that it prefers to run in a circle, since it gets positive rewards for each step, instead of reaching for the food. <br><br>

                <h4><b>Deep Neural Network</b></h4>
                The brain of the artificial intelligence uses <b>Deep learning</b>. It consists of 3 hidden layers of 120 neurons, and three Dropout layers to optimize generalization and reduce overfitting. The learning rate is not fixed, it starts at 0.0005 and decreases to 0.000005. Different architectures and different hyper-parameters contribute to a quicker convergence to an optimum, as well as possible highest scores.<br>
                The network receives as input the state, and returns as output three values related to the three actions: move left, move right, move straight. The last layer uses the Softmax function to returns probabilities. <br>
                <img class="snake-neural-net" src="img/neural_net.PNG" style="margin: auto; display: block"><br>

                <h4><b>Final results</b></h4>
                At the end of the implementation, the AI scores 40 points on average in a 20x20 game board ( Each fruit eaten rewards one point). The record is 83 points. <br>
                To visualize the learning process and how effective is the approach of Deep Reinforcement Learning, I plot scores along the matches. As we can see in the graph below, during the first 50 games the AI scores poorly, less than 10 points on average. Indeed, in this phase, the system is often taking random actions, in order to explore the board and store in its memory many different states, actions, and rewards. During the last 50 games the system is not taking random actions anymore, but it only chooses what to do based on its neural network.<br>
                <blockquote>
                    <p><b>In only 150 games - less than 5 minutes - the system went from 0 points and no clue whatsoever on the rules to 45 points and a solid strategy!</b></p>
                </blockquote>
                <img class="snake-score" src="img/result.PNG" style="display: block; margin: auto">
            </div>
        </div>
    </section>


    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-to-top d-lg-none position-fixed ">
        <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>
    <br>


    <!-- Math Jax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/freelancer.min.js"></script>

</body>

</html>
