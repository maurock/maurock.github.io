<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Develop an AI agent using Deep Reinforcement Learning to play the game Snake">
    <meta name="author" content="Mauro Comi">
    <title>Deep Reinforcement Learning for Games</title>
    
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Raleway:700,200,400,300, 500" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:700,200,400,300, 500" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <!-- Plugin CSS -->
    <link href="vendor/magnific-popup/magnific-popup.css" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template -->
    <link href="css/freelancer.css" rel="stylesheet">

</head>

<body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav">
        <div class="container">
            <a class="navbar-brand js-scroll-trigger" style="font-family: Raleway; font-size: 20px;" href="https://maurocomi.com/index.html">Mauro Comi</a>
            <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fa fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#research">Research</a>
                        </div>
                    </li>
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#portfolio">My Projects</a>
                        </div>
                    </li>
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#about_desktop_mobile">About me</a>
                        </div>
                    </li>
                    <li class="nav-item mx-0 mx-lg-1">
                        <div>
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="index.html#contact">Contact</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <!-- Code -->
    <section class="code" id="prediction">
        <div class="container container-blog">
            <h2 class="text-center text-uppercase text-secondary mb-0" style="margin-top: 50px; line-height: 1.2">Deep Reinforcement Learning for Game Bot</h2>
            <br><br>
            <img src="img/neural-network.jpg" class="container" style="max-width: 100%; height: 30vh;object-fit: cover">

            <div class="snippet">
                <h3><b>Introduction</b></h3>The goal of this project is to develop an <b>AI agent</b> that is able to learn how to play the popular game Snake from scratch. To do so, I implemented a <b>Deep Reinforcement Learning algorithm</b>. This approach consists in the interaction between two components: an environment (the game itself) and an agent (Snake). The agent collects information about its current state (we will see later what this means) and performs an action accordingly. The environment rewards or punishes the agent based on the performed action. Over time, the agent learns what actions maximize the reward (in our case, what actions lead to eating the apple and avoiding the walls). No rules about the game are given. Initially, Snake does not know what to do and performs random actions. The goal is to figure it out and elaborate a strategy (technically called "policy") to maximize the score - or the reward.<br>
                We are going to see how a <b>Deep Q-Learning algorithm</b> learns how to play Snake, scoring up to 50 points and showing a solid strategy in just 5 minutes.<br> Optionally, the code shows how to optimize the artificial neural networks parameters using <a href="https://distill.pub/2020/bayesian-optimization/">Bayesian Optimization</a>. This procedure is not necessary, but I want to mention it for the advanced readers. 
                You can check the <span><b>GitHub Repository</b><img src="img/github-icon.png" style="height: 20px; margin-left: 5px;"></span> for the full code: <br>
                <a href="https://github.com/maurock/snake-ga" class="text-center btn_custom-inverse first_btn-inverse" style="font-size: 16px; font-family: Roboto; font-weight: 500; width: fit-content; margin: auto; margin-bottom: 10px; margin-top: 10px">Check full code<span class="fa fa-long-arrow-right" aria-hidden="true" style="margin-left: 8px"></span></a>

                Here you can see the two games: on the left, the AI <i>before</i> training. On the right, the AI <i>after</i> training.<br>

                <div style="text-align: center">
                    <img class="snakegif-norl" , src="img/notraining.gif">
                    <img class="snakegif-rl" src="img/training.gif">
                </div>
                <br><br>
                <h3><b>Learning goals</b></h3>
                <ul>
                    <li>Understand and Implement a Deep Q-Learning algorithm for optimization</li>
                    <li>Improve the algorithm with different strategies -> Store long-term memory, Experience memory, Random actions</li>
                </ul>
                <br>
                <h3><b>How does it work?</b></h3>
                <p>In my implementation, I used <b>Deep Q-Learning</b> instead of a traditional supervised Machine Learning approach. What's the difference? Traditional ML algorithms need to be trained with an input and a "correct answer" called target. The system tries to learn how to predict the target from new input. In this example, we don't know the best action to take at each state of the game (this is actually what we are trying to learn!), so a traditional approach would not be effective. This is why we use Reinforcement Learning. </p>
                    
                <h4><b>Reinforcement Learning in a nutshell</b></h4>
                <p>Reinforcement Learning is a family of algorithms and techniques used for Control (e.g. Robotics, Autonomous driving, etc..) and Decision making. These approaches solve problems that need to be expressed as a Markov Decision Process (MDP). What does this mean? A Markov Decision Process is a framework described by a set of states \(\mathcal{S}\) (for example, an index based on Snake's position), a set of actions \(\mathcal{A}\) (for example, Up, Down, Right, Left), a reward function \(\mathcal{R}\) (for example, +10 when Snake eats an apple, -10 when Snakes hits a wall) and optionally a transition function \(\mathcal{T}\) that describes the transitions among states. To use Reinforcement Learning, we need to formalize our problem using these 4 components. If this is confusing, <i>fear not</i>, everything will be clear in a few minutes. <br>                
                In Reinforcement Learning, we have two main components: the <b>environment</b> (our game) and the <b>agent</b> (our Snake.. or to be correct, the Deep Neural Network that drives our Snake's actions). Every time the agent performs an action, the environment gives a reward to the agent, which can be positive or negative depending on how good the action was from that specific state. The goal of the agent is to learn what actions maximize the reward, given every possible state. States are the observations that the agent receives at each iteration from the environment. A state can be its position, its speed, or whatever array of variables describes the environment. To be more rigorous and to use a Reinforcement Learning notation, the strategy used by the agent to make decisions is called <b>policy</b>. On a theoretical level, a policy is a mapping from the state space (the space of all the possible observations that the agent can receive) into the action space (the space of all the actions the agent can take, say UP, DOWN, LEFT and RIGHT). The optimal agent can generalize over the entire state space to always predict the best possible action.. even for those situations that the agent has never seen before! If this is not clear, the next example will clarify your doubts. </p>

                <h4><b>How does the agent take decisions?</b></h4>

                To understand how the agent takes decisions, it is very important to understand what a Q-Table is. A Q-table is a matrix that relates the <i>state</i> of the agent to the possible actions that it can take. The values in the table are the actions' probability of success (technically, a measure of the expected cumulative reward), which were updated based on the rewards the agent received during training. An example of a greedy policy is a policy where the agent looks up the table and selects the action that leads to the highest score. <br>
                <br>
                <div>
                    <table class="table table-bordered" style="width: 60%; line-height :1em; margin: auto">
                        <thead>
                            <tr>
                                <th scope="col">State</th>
                                <th scope="col">Right</th>
                                <th scope="col">Left</th>
                                <th scope="col">Up</th>
                                <th scope="col">Down</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td>0</td>
                                <td>0.31</td>
                                <td>0.12</td>
                                <td style="background-color: #19ce0085">0.87</td>
                            </tr>
                            <tr>
                                <th scope="row">2</th>
                                <td style="background-color: #19ce0085">0.98</td>
                                <td>-0.12</td>
                                <td>0.01</td>
                                <td>0.14</td>
                            </tr>
                            <tr>
                                <th scope="row">3</th>
                                <td>1</td>
                                <td>0.10</td>
                                <td>0.12</td>
                                <td style="background-color: #19ce0085">0.31</td>
                            </tr>
                            <tr>
                                <th scope="row">4</th>
                                <td>0.19</td>
                                <td>0.14</td>
                                <td style="background-color: #19ce0085">0.87</td>
                                <td>-0.12</td>
                            </tr>
                        </tbody>

                    </table>
                    <p style="text-align: center;"><i>Representation of a Q-Table</i></p>
                </div>
                
                In the example, we might want to choose RIGHT if we are in State 2, and we might want to go UP if we are in State 4. The values in the Q-Table represent the cumulative expected reward of taking action <i>a</i> from a state <i>a</i>. In other words, these values give us an indication of the average reward that the agent obtains if it takes action a from that state sÂ .This table is the policy of the agent that we mentioned before: it determines what actions should be taken from every state to maximize the expected reward. What is the problem with this? The policy is a table, hence it can only handle a finite state space. In other words, we cannot have an infinitely large table with infinite states. This might be a problem for those situations where we have a very big number of possible states.
                <br>
                Deep Q-Learning increases the potentiality of Q-Learning by "converting" the Q-matrix into a Neural Network - a powerful representation of a parametrized function. <br>
                The Q-values are updated according to the Bellman equation: <br><br>
                <img class="bellman-eq" src="img/bellman.bmp.png" style="margin: auto;display: block;"><br>

                On a general level the algorithm works as follow:<br>
                <ul>
                    <li> The game starts, and the Q-value is randomly initialized.</li>
                    <li>The system gets the current state <b>s</b>.</li>
                    <li>The agent executes an <b>action</b> based on the collected state. The action can either be random or returned by its neural network. During the first phase of the training, the system often chooses random actions to maximize <b>exploration</b>. Later on, the system relies more and more on its neural network.</li>
                    <li>When the AI chooses and performs the action, the environment attributes a <b>reward</b>. It now gets the new state <b>state'</b> and it updates its Q-value with the Bellman equation as mentioned above. Also, for each move it stores the original state, the action, the state reached after performed that action, the reward obtained and whether the game ended or not. This data is later sampled to train the neural network.</li>
                    <li>These last two operations are repeated until a certain condition is met</li><br>
                </ul>
                <h4><b>State</b></h4>
                A state is the representation of a situation in which the agent finds itself.
                The state represents the input of the Neural network of the AI. <br>
                In our case, the state is an array containing 11 boolean variables. It takes into account:<br>
                - if there's an immediate danger in the snake's proximity (right, left and straight).<br>
                - if the snake is moving up, down, left or right.<br>
                - if the food is above, below, on the left or on the right.<br><br>

                <h4><b>Loss</b></h4>
                The Deep neural network optimizes the answer (action) to a specific input (state) while trying to maximize the reward. The value to express how good is the prediction is called Loss. The job of a neural network is to minimize the loss, reducing then the difference between the real target and the predicted one.
                In our case, the loss is expressed as:

                $$ loss = \left( r + \gamma max_a  \textcolor{red}{\hat{Q}}(s, a') - \textcolor{red}{Q}(s, a) \right)^2 $$

                
                
                <h4><b>Reward</b></h4>
                As said, the AI tries to maximize the reward.
                We positively reward the agent when it eats the food target (+10). If Snake hits a wall or hits itself, we punish the agent with a negative reward (-10). Additionally, we could give a positive reward for each step Snake takes without dying. In that case, Snake might exploit the situation by running in a circle instead of reaching the food, since it would get positive rewards for each step while avoiding the risk of collision against a wall. Sometimes, Reinforcement Learning agents outsmart us, presenting flaws in our strategy that we did not anticipate. <br><br>

                <h4><b>Deep Neural Network</b></h4>
                The brain of our Artificial Intelligence agent uses <b>Deep learning</b>. It consists of 3 hidden layers of 120 neurons, and three Dropout layers to optimize generalization while reducing overfitting. The learning rate is not fixed, it starts at 0.0005 and decreases to 0.000005. Different architectures and different hyper-parameters contribute to a quicker convergence to an optimum, as well as possible highest scores.<br>
                The network receives as input the state, and returns as output three values related to the three actions: move left, move right, move straight. The last layer uses the Softmax function. <br>
                <img class="snake-neural-net" src="img/neural_net.PNG" style="margin: auto; display: block"><br>

                <h4><b>Final results</b></h4>
                At the end of the implementation, the AI scores 40 points on average in a 20x20 game board (each fruit eaten rewards one point). The record is 83 points. <br>
                To visualize the learning process and how effective the approach of Deep Reinforcement Learning is, I plot scores along the matches. As we can see in the graph below, during the first 50 games the AI scores poorly (less than 10 points on average). This is expected: the system is taking random actions to explore the board and store many different states, actions, and rewards in its memory. During the last 50 games, the agent does not take random actions anymore, but it only chooses the best actions according to its policy.<br>
                <blockquote>
                    <p><b>In only 150 games - less than 5 minutes - the agent learnt a solid strategy and scored 45 points!</b></p>
                </blockquote>
                <img class="snake-score" src="img/result.PNG" style="display: block; margin: auto">
            </div>
        </div>
    </section>


    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-to-top d-lg-none position-fixed ">
        <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>
    <br>


    <!-- Math Jax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/freelancer.min.js"></script>

</body>

</html>
